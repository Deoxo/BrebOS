#include "interrupts.h"
#include "fb.h"
#include "keyboard.h"

extern void interrupt_handler_0();

extern void interrupt_handler_1();

extern void interrupt_handler_2();

extern void interrupt_handler_3();

extern void interrupt_handler_4();

extern void interrupt_handler_5();

extern void interrupt_handler_6();

extern void interrupt_handler_7();

extern void interrupt_handler_8();

extern void interrupt_handler_9();

extern void interrupt_handler_10();

extern void interrupt_handler_11();

extern void interrupt_handler_12();

extern void interrupt_handler_13();

extern void interrupt_handler_14();

extern void interrupt_handler_15();

extern void interrupt_handler_16();

extern void interrupt_handler_17();

extern void interrupt_handler_18();

extern void interrupt_handler_19();

extern void interrupt_handler_20();

extern void interrupt_handler_21();

extern void interrupt_handler_22();

extern void interrupt_handler_23();

extern void interrupt_handler_24();

extern void interrupt_handler_25();

extern void interrupt_handler_26();

extern void interrupt_handler_27();

extern void interrupt_handler_28();

extern void interrupt_handler_29();

extern void interrupt_handler_30();

extern void interrupt_handler_31();

extern void interrupt_handler_32();

extern void interrupt_handler_33();

extern void interrupt_handler_34();

extern void interrupt_handler_35();

extern void interrupt_handler_36();

extern void interrupt_handler_37();

extern void interrupt_handler_38();

extern void interrupt_handler_39();

extern void interrupt_handler_40();

extern void interrupt_handler_41();

extern void interrupt_handler_42();

extern void interrupt_handler_43();

extern void interrupt_handler_44();

extern void interrupt_handler_45();

extern void interrupt_handler_46();

extern void interrupt_handler_47();

extern void interrupt_handler_48();

extern void interrupt_handler_49();

extern void interrupt_handler_50();

extern void interrupt_handler_51();

extern void interrupt_handler_52();

extern void interrupt_handler_53();

extern void interrupt_handler_54();

extern void interrupt_handler_55();

extern void interrupt_handler_56();

extern void interrupt_handler_57();

extern void interrupt_handler_58();

extern void interrupt_handler_59();

extern void interrupt_handler_60();

extern void interrupt_handler_61();

extern void interrupt_handler_62();

extern void interrupt_handler_63();

extern void interrupt_handler_64();

extern void interrupt_handler_65();

extern void interrupt_handler_66();

extern void interrupt_handler_67();

extern void interrupt_handler_68();

extern void interrupt_handler_69();

extern void interrupt_handler_70();

extern void interrupt_handler_71();

extern void interrupt_handler_72();

extern void interrupt_handler_73();

extern void interrupt_handler_74();

extern void interrupt_handler_75();

extern void interrupt_handler_76();

extern void interrupt_handler_77();

extern void interrupt_handler_78();

extern void interrupt_handler_79();

extern void interrupt_handler_80();

extern void interrupt_handler_81();

extern void interrupt_handler_82();

extern void interrupt_handler_83();

extern void interrupt_handler_84();

extern void interrupt_handler_85();

extern void interrupt_handler_86();

extern void interrupt_handler_87();

extern void interrupt_handler_88();

extern void interrupt_handler_89();

extern void interrupt_handler_90();

extern void interrupt_handler_91();

extern void interrupt_handler_92();

extern void interrupt_handler_93();

extern void interrupt_handler_94();

extern void interrupt_handler_95();

extern void interrupt_handler_96();

extern void interrupt_handler_97();

extern void interrupt_handler_98();

extern void interrupt_handler_99();

extern void interrupt_handler_100();

extern void interrupt_handler_101();

extern void interrupt_handler_102();

extern void interrupt_handler_103();

extern void interrupt_handler_104();

extern void interrupt_handler_105();

extern void interrupt_handler_106();

extern void interrupt_handler_107();

extern void interrupt_handler_108();

extern void interrupt_handler_109();

extern void interrupt_handler_110();

extern void interrupt_handler_111();

extern void interrupt_handler_112();

extern void interrupt_handler_113();

extern void interrupt_handler_114();

extern void interrupt_handler_115();

extern void interrupt_handler_116();

extern void interrupt_handler_117();

extern void interrupt_handler_118();

extern void interrupt_handler_119();

extern void interrupt_handler_120();

extern void interrupt_handler_121();

extern void interrupt_handler_122();

extern void interrupt_handler_123();

extern void interrupt_handler_124();

extern void interrupt_handler_125();

extern void interrupt_handler_126();

extern void interrupt_handler_127();

extern void interrupt_handler_128();

extern void interrupt_handler_129();

extern void interrupt_handler_130();

extern void interrupt_handler_131();

extern void interrupt_handler_132();

extern void interrupt_handler_133();

extern void interrupt_handler_134();

extern void interrupt_handler_135();

extern void interrupt_handler_136();

extern void interrupt_handler_137();

extern void interrupt_handler_138();

extern void interrupt_handler_139();

extern void interrupt_handler_140();

extern void interrupt_handler_141();

extern void interrupt_handler_142();

extern void interrupt_handler_143();

extern void interrupt_handler_144();

extern void interrupt_handler_145();

extern void interrupt_handler_146();

extern void interrupt_handler_147();

extern void interrupt_handler_148();

extern void interrupt_handler_149();

extern void interrupt_handler_150();

extern void interrupt_handler_151();

extern void interrupt_handler_152();

extern void interrupt_handler_153();

extern void interrupt_handler_154();

extern void interrupt_handler_155();

extern void interrupt_handler_156();

extern void interrupt_handler_157();

extern void interrupt_handler_158();

extern void interrupt_handler_159();

extern void interrupt_handler_160();

extern void interrupt_handler_161();

extern void interrupt_handler_162();

extern void interrupt_handler_163();

extern void interrupt_handler_164();

extern void interrupt_handler_165();

extern void interrupt_handler_166();

extern void interrupt_handler_167();

extern void interrupt_handler_168();

extern void interrupt_handler_169();

extern void interrupt_handler_170();

extern void interrupt_handler_171();

extern void interrupt_handler_172();

extern void interrupt_handler_173();

extern void interrupt_handler_174();

extern void interrupt_handler_175();

extern void interrupt_handler_176();

extern void interrupt_handler_177();

extern void interrupt_handler_178();

extern void interrupt_handler_179();

extern void interrupt_handler_180();

extern void interrupt_handler_181();

extern void interrupt_handler_182();

extern void interrupt_handler_183();

extern void interrupt_handler_184();

extern void interrupt_handler_185();

extern void interrupt_handler_186();

extern void interrupt_handler_187();

extern void interrupt_handler_188();

extern void interrupt_handler_189();

extern void interrupt_handler_190();

extern void interrupt_handler_191();

extern void interrupt_handler_192();

extern void interrupt_handler_193();

extern void interrupt_handler_194();

extern void interrupt_handler_195();

extern void interrupt_handler_196();

extern void interrupt_handler_197();

extern void interrupt_handler_198();

extern void interrupt_handler_199();

extern void interrupt_handler_200();

extern void interrupt_handler_201();

extern void interrupt_handler_202();

extern void interrupt_handler_203();

extern void interrupt_handler_204();

extern void interrupt_handler_205();

extern void interrupt_handler_206();

extern void interrupt_handler_207();

extern void interrupt_handler_208();

extern void interrupt_handler_209();

extern void interrupt_handler_210();

extern void interrupt_handler_211();

extern void interrupt_handler_212();

extern void interrupt_handler_213();

extern void interrupt_handler_214();

extern void interrupt_handler_215();

extern void interrupt_handler_216();

extern void interrupt_handler_217();

extern void interrupt_handler_218();

extern void interrupt_handler_219();

extern void interrupt_handler_220();

extern void interrupt_handler_221();

extern void interrupt_handler_222();

extern void interrupt_handler_223();

extern void interrupt_handler_224();

extern void interrupt_handler_225();

extern void interrupt_handler_226();

extern void interrupt_handler_227();

extern void interrupt_handler_228();

extern void interrupt_handler_229();

extern void interrupt_handler_230();

extern void interrupt_handler_231();

extern void interrupt_handler_232();

extern void interrupt_handler_233();

extern void interrupt_handler_234();

extern void interrupt_handler_235();

extern void interrupt_handler_236();

extern void interrupt_handler_237();

extern void interrupt_handler_238();

extern void interrupt_handler_239();

extern void interrupt_handler_240();

extern void interrupt_handler_241();

extern void interrupt_handler_242();

extern void interrupt_handler_243();

extern void interrupt_handler_244();

extern void interrupt_handler_245();

extern void interrupt_handler_246();

extern void interrupt_handler_247();

extern void interrupt_handler_248();

extern void interrupt_handler_249();

extern void interrupt_handler_250();

extern void interrupt_handler_251();

extern void interrupt_handler_252();

extern void interrupt_handler_253();

extern void interrupt_handler_254();

extern void interrupt_handler_255();

unsigned char read_scan_code(void)
{
	return inb(KBD_DATA_PORT);
}

void pic_acknowledge(unsigned int interrupt)
{
    if (interrupt < PIC1_START_INTERRUPT || interrupt > PIC2_END_INTERRUPT)
		return;

	outb(interrupt < PIC2_START_INTERRUPT ? PIC1 : PIC2, PIC_ACK);
}

void idt_init(struct idt* idt_ptr, struct idt_entry* idt)
{
	// Use the macro to declare all interrupt handlers
	idt_ptr->size = (sizeof(struct idt_entry)) * NUM_INTERRUPTS - 1;
	idt_ptr->address = idt;

	idt_set_entry(idt, 0, (unsigned int) interrupt_handler_0, 0x08, INTGATE);
	idt_set_entry(idt, 1, (unsigned int) interrupt_handler_1, 0x08, INTGATE);
	idt_set_entry(idt, 2, (unsigned int) interrupt_handler_2, 0x08, INTGATE);
	idt_set_entry(idt, 3, (unsigned int) interrupt_handler_3, 0x08, INTGATE);
	idt_set_entry(idt, 4, (unsigned int) interrupt_handler_4, 0x08, INTGATE);
	idt_set_entry(idt, 5, (unsigned int) interrupt_handler_5, 0x08, INTGATE);
	idt_set_entry(idt, 6, (unsigned int) interrupt_handler_6, 0x08, INTGATE);
	idt_set_entry(idt, 7, (unsigned int) interrupt_handler_7, 0x08, INTGATE);
	idt_set_entry(idt, 8, (unsigned int) interrupt_handler_8, 0x08, INTGATE);
	idt_set_entry(idt, 9, (unsigned int) interrupt_handler_9, 0x08, INTGATE);
	idt_set_entry(idt, 10, (unsigned int) interrupt_handler_10, 0x08, INTGATE);
	idt_set_entry(idt, 11, (unsigned int) interrupt_handler_11, 0x08, INTGATE);
	idt_set_entry(idt, 12, (unsigned int) interrupt_handler_12, 0x08, INTGATE);
	idt_set_entry(idt, 13, (unsigned int) interrupt_handler_13, 0x08, INTGATE);
	idt_set_entry(idt, 14, (unsigned int) interrupt_handler_14, 0x08, INTGATE);
	idt_set_entry(idt, 15, (unsigned int) interrupt_handler_15, 0x08, INTGATE);
	idt_set_entry(idt, 16, (unsigned int) interrupt_handler_16, 0x08, INTGATE);
	idt_set_entry(idt, 17, (unsigned int) interrupt_handler_17, 0x08, INTGATE);
	idt_set_entry(idt, 18, (unsigned int) interrupt_handler_18, 0x08, INTGATE);
	idt_set_entry(idt, 19, (unsigned int) interrupt_handler_19, 0x08, INTGATE);
	idt_set_entry(idt, 20, (unsigned int) interrupt_handler_20, 0x08, INTGATE);
	idt_set_entry(idt, 21, (unsigned int) interrupt_handler_21, 0x08, INTGATE);
	idt_set_entry(idt, 22, (unsigned int) interrupt_handler_22, 0x08, INTGATE);
	idt_set_entry(idt, 23, (unsigned int) interrupt_handler_23, 0x08, INTGATE);
	idt_set_entry(idt, 24, (unsigned int) interrupt_handler_24, 0x08, INTGATE);
	idt_set_entry(idt, 25, (unsigned int) interrupt_handler_25, 0x08, INTGATE);
	idt_set_entry(idt, 26, (unsigned int) interrupt_handler_26, 0x08, INTGATE);
	idt_set_entry(idt, 27, (unsigned int) interrupt_handler_27, 0x08, INTGATE);
	idt_set_entry(idt, 28, (unsigned int) interrupt_handler_28, 0x08, INTGATE);
	idt_set_entry(idt, 29, (unsigned int) interrupt_handler_29, 0x08, INTGATE);
	idt_set_entry(idt, 30, (unsigned int) interrupt_handler_30, 0x08, INTGATE);
	idt_set_entry(idt, 31, (unsigned int) interrupt_handler_31, 0x08, INTGATE);
	idt_set_entry(idt, 32, (unsigned int) interrupt_handler_32, 0x08, INTGATE);
	idt_set_entry(idt, 33, (unsigned int) interrupt_handler_33, 0x08, INTGATE);
	idt_set_entry(idt, 34, (unsigned int) interrupt_handler_34, 0x08, INTGATE);
	idt_set_entry(idt, 35, (unsigned int) interrupt_handler_35, 0x08, INTGATE);
	idt_set_entry(idt, 36, (unsigned int) interrupt_handler_36, 0x08, INTGATE);
	idt_set_entry(idt, 37, (unsigned int) interrupt_handler_37, 0x08, INTGATE);
	idt_set_entry(idt, 38, (unsigned int) interrupt_handler_38, 0x08, INTGATE);
	idt_set_entry(idt, 39, (unsigned int) interrupt_handler_39, 0x08, INTGATE);
	idt_set_entry(idt, 40, (unsigned int) interrupt_handler_40, 0x08, INTGATE);
	idt_set_entry(idt, 41, (unsigned int) interrupt_handler_41, 0x08, INTGATE);
	idt_set_entry(idt, 42, (unsigned int) interrupt_handler_42, 0x08, INTGATE);
	idt_set_entry(idt, 43, (unsigned int) interrupt_handler_43, 0x08, INTGATE);
	idt_set_entry(idt, 44, (unsigned int) interrupt_handler_44, 0x08, INTGATE);
	idt_set_entry(idt, 45, (unsigned int) interrupt_handler_45, 0x08, INTGATE);
	idt_set_entry(idt, 46, (unsigned int) interrupt_handler_46, 0x08, INTGATE);
	idt_set_entry(idt, 47, (unsigned int) interrupt_handler_47, 0x08, INTGATE);
	idt_set_entry(idt, 48, (unsigned int) interrupt_handler_48, 0x08, INTGATE);
	idt_set_entry(idt, 49, (unsigned int) interrupt_handler_49, 0x08, INTGATE);
	idt_set_entry(idt, 50, (unsigned int) interrupt_handler_50, 0x08, INTGATE);
	idt_set_entry(idt, 51, (unsigned int) interrupt_handler_51, 0x08, INTGATE);
	idt_set_entry(idt, 52, (unsigned int) interrupt_handler_52, 0x08, INTGATE);
	idt_set_entry(idt, 53, (unsigned int) interrupt_handler_53, 0x08, INTGATE);
	idt_set_entry(idt, 54, (unsigned int) interrupt_handler_54, 0x08, INTGATE);
	idt_set_entry(idt, 55, (unsigned int) interrupt_handler_55, 0x08, INTGATE);
	idt_set_entry(idt, 56, (unsigned int) interrupt_handler_56, 0x08, INTGATE);
	idt_set_entry(idt, 57, (unsigned int) interrupt_handler_57, 0x08, INTGATE);
	idt_set_entry(idt, 58, (unsigned int) interrupt_handler_58, 0x08, INTGATE);
	idt_set_entry(idt, 59, (unsigned int) interrupt_handler_59, 0x08, INTGATE);
	idt_set_entry(idt, 60, (unsigned int) interrupt_handler_60, 0x08, INTGATE);
	idt_set_entry(idt, 61, (unsigned int) interrupt_handler_61, 0x08, INTGATE);
	idt_set_entry(idt, 62, (unsigned int) interrupt_handler_62, 0x08, INTGATE);
	idt_set_entry(idt, 63, (unsigned int) interrupt_handler_63, 0x08, INTGATE);
	idt_set_entry(idt, 64, (unsigned int) interrupt_handler_64, 0x08, INTGATE);
	idt_set_entry(idt, 65, (unsigned int) interrupt_handler_65, 0x08, INTGATE);
	idt_set_entry(idt, 66, (unsigned int) interrupt_handler_66, 0x08, INTGATE);
	idt_set_entry(idt, 67, (unsigned int) interrupt_handler_67, 0x08, INTGATE);
	idt_set_entry(idt, 68, (unsigned int) interrupt_handler_68, 0x08, INTGATE);
	idt_set_entry(idt, 69, (unsigned int) interrupt_handler_69, 0x08, INTGATE);
	idt_set_entry(idt, 70, (unsigned int) interrupt_handler_70, 0x08, INTGATE);
	idt_set_entry(idt, 71, (unsigned int) interrupt_handler_71, 0x08, INTGATE);
	idt_set_entry(idt, 72, (unsigned int) interrupt_handler_72, 0x08, INTGATE);
	idt_set_entry(idt, 73, (unsigned int) interrupt_handler_73, 0x08, INTGATE);
	idt_set_entry(idt, 74, (unsigned int) interrupt_handler_74, 0x08, INTGATE);
	idt_set_entry(idt, 75, (unsigned int) interrupt_handler_75, 0x08, INTGATE);
	idt_set_entry(idt, 76, (unsigned int) interrupt_handler_76, 0x08, INTGATE);
	idt_set_entry(idt, 77, (unsigned int) interrupt_handler_77, 0x08, INTGATE);
	idt_set_entry(idt, 78, (unsigned int) interrupt_handler_78, 0x08, INTGATE);
	idt_set_entry(idt, 79, (unsigned int) interrupt_handler_79, 0x08, INTGATE);
	idt_set_entry(idt, 80, (unsigned int) interrupt_handler_80, 0x08, INTGATE);
	idt_set_entry(idt, 81, (unsigned int) interrupt_handler_81, 0x08, INTGATE);
	idt_set_entry(idt, 82, (unsigned int) interrupt_handler_82, 0x08, INTGATE);
	idt_set_entry(idt, 83, (unsigned int) interrupt_handler_83, 0x08, INTGATE);
	idt_set_entry(idt, 84, (unsigned int) interrupt_handler_84, 0x08, INTGATE);
	idt_set_entry(idt, 85, (unsigned int) interrupt_handler_85, 0x08, INTGATE);
	idt_set_entry(idt, 86, (unsigned int) interrupt_handler_86, 0x08, INTGATE);
	idt_set_entry(idt, 87, (unsigned int) interrupt_handler_87, 0x08, INTGATE);
	idt_set_entry(idt, 88, (unsigned int) interrupt_handler_88, 0x08, INTGATE);
	idt_set_entry(idt, 89, (unsigned int) interrupt_handler_89, 0x08, INTGATE);
	idt_set_entry(idt, 90, (unsigned int) interrupt_handler_90, 0x08, INTGATE);
	idt_set_entry(idt, 91, (unsigned int) interrupt_handler_91, 0x08, INTGATE);
	idt_set_entry(idt, 92, (unsigned int) interrupt_handler_92, 0x08, INTGATE);
	idt_set_entry(idt, 93, (unsigned int) interrupt_handler_93, 0x08, INTGATE);
	idt_set_entry(idt, 94, (unsigned int) interrupt_handler_94, 0x08, INTGATE);
	idt_set_entry(idt, 95, (unsigned int) interrupt_handler_95, 0x08, INTGATE);
	idt_set_entry(idt, 96, (unsigned int) interrupt_handler_96, 0x08, INTGATE);
	idt_set_entry(idt, 97, (unsigned int) interrupt_handler_97, 0x08, INTGATE);
	idt_set_entry(idt, 98, (unsigned int) interrupt_handler_98, 0x08, INTGATE);
	idt_set_entry(idt, 99, (unsigned int) interrupt_handler_99, 0x08, INTGATE);
	idt_set_entry(idt, 100, (unsigned int) interrupt_handler_100, 0x08, INTGATE);
	idt_set_entry(idt, 101, (unsigned int) interrupt_handler_101, 0x08, INTGATE);
	idt_set_entry(idt, 102, (unsigned int) interrupt_handler_102, 0x08, INTGATE);
	idt_set_entry(idt, 103, (unsigned int) interrupt_handler_103, 0x08, INTGATE);
	idt_set_entry(idt, 104, (unsigned int) interrupt_handler_104, 0x08, INTGATE);
	idt_set_entry(idt, 105, (unsigned int) interrupt_handler_105, 0x08, INTGATE);
	idt_set_entry(idt, 106, (unsigned int) interrupt_handler_106, 0x08, INTGATE);
	idt_set_entry(idt, 107, (unsigned int) interrupt_handler_107, 0x08, INTGATE);
	idt_set_entry(idt, 108, (unsigned int) interrupt_handler_108, 0x08, INTGATE);
	idt_set_entry(idt, 109, (unsigned int) interrupt_handler_109, 0x08, INTGATE);
	idt_set_entry(idt, 110, (unsigned int) interrupt_handler_110, 0x08, INTGATE);
	idt_set_entry(idt, 111, (unsigned int) interrupt_handler_111, 0x08, INTGATE);
	idt_set_entry(idt, 112, (unsigned int) interrupt_handler_112, 0x08, INTGATE);
	idt_set_entry(idt, 113, (unsigned int) interrupt_handler_113, 0x08, INTGATE);
	idt_set_entry(idt, 114, (unsigned int) interrupt_handler_114, 0x08, INTGATE);
	idt_set_entry(idt, 115, (unsigned int) interrupt_handler_115, 0x08, INTGATE);
	idt_set_entry(idt, 116, (unsigned int) interrupt_handler_116, 0x08, INTGATE);
	idt_set_entry(idt, 117, (unsigned int) interrupt_handler_117, 0x08, INTGATE);
	idt_set_entry(idt, 118, (unsigned int) interrupt_handler_118, 0x08, INTGATE);
	idt_set_entry(idt, 119, (unsigned int) interrupt_handler_119, 0x08, INTGATE);
	idt_set_entry(idt, 120, (unsigned int) interrupt_handler_120, 0x08, INTGATE);
	idt_set_entry(idt, 121, (unsigned int) interrupt_handler_121, 0x08, INTGATE);
	idt_set_entry(idt, 122, (unsigned int) interrupt_handler_122, 0x08, INTGATE);
	idt_set_entry(idt, 123, (unsigned int) interrupt_handler_123, 0x08, INTGATE);
	idt_set_entry(idt, 124, (unsigned int) interrupt_handler_124, 0x08, INTGATE);
	idt_set_entry(idt, 125, (unsigned int) interrupt_handler_125, 0x08, INTGATE);
	idt_set_entry(idt, 126, (unsigned int) interrupt_handler_126, 0x08, INTGATE);
	idt_set_entry(idt, 127, (unsigned int) interrupt_handler_127, 0x08, INTGATE);
	idt_set_entry(idt, 128, (unsigned int) interrupt_handler_128, 0x08, INTGATE);
	idt_set_entry(idt, 129, (unsigned int) interrupt_handler_129, 0x08, INTGATE);
	idt_set_entry(idt, 130, (unsigned int) interrupt_handler_130, 0x08, INTGATE);
	idt_set_entry(idt, 131, (unsigned int) interrupt_handler_131, 0x08, INTGATE);
	idt_set_entry(idt, 132, (unsigned int) interrupt_handler_132, 0x08, INTGATE);
	idt_set_entry(idt, 133, (unsigned int) interrupt_handler_133, 0x08, INTGATE);
	idt_set_entry(idt, 134, (unsigned int) interrupt_handler_134, 0x08, INTGATE);
	idt_set_entry(idt, 135, (unsigned int) interrupt_handler_135, 0x08, INTGATE);
	idt_set_entry(idt, 136, (unsigned int) interrupt_handler_136, 0x08, INTGATE);
	idt_set_entry(idt, 137, (unsigned int) interrupt_handler_137, 0x08, INTGATE);
	idt_set_entry(idt, 138, (unsigned int) interrupt_handler_138, 0x08, INTGATE);
	idt_set_entry(idt, 139, (unsigned int) interrupt_handler_139, 0x08, INTGATE);
	idt_set_entry(idt, 140, (unsigned int) interrupt_handler_140, 0x08, INTGATE);
	idt_set_entry(idt, 141, (unsigned int) interrupt_handler_141, 0x08, INTGATE);
	idt_set_entry(idt, 142, (unsigned int) interrupt_handler_142, 0x08, INTGATE);
	idt_set_entry(idt, 143, (unsigned int) interrupt_handler_143, 0x08, INTGATE);
	idt_set_entry(idt, 144, (unsigned int) interrupt_handler_144, 0x08, INTGATE);
	idt_set_entry(idt, 145, (unsigned int) interrupt_handler_145, 0x08, INTGATE);
	idt_set_entry(idt, 146, (unsigned int) interrupt_handler_146, 0x08, INTGATE);
	idt_set_entry(idt, 147, (unsigned int) interrupt_handler_147, 0x08, INTGATE);
	idt_set_entry(idt, 148, (unsigned int) interrupt_handler_148, 0x08, INTGATE);
	idt_set_entry(idt, 149, (unsigned int) interrupt_handler_149, 0x08, INTGATE);
	idt_set_entry(idt, 150, (unsigned int) interrupt_handler_150, 0x08, INTGATE);
	idt_set_entry(idt, 151, (unsigned int) interrupt_handler_151, 0x08, INTGATE);
	idt_set_entry(idt, 152, (unsigned int) interrupt_handler_152, 0x08, INTGATE);
	idt_set_entry(idt, 153, (unsigned int) interrupt_handler_153, 0x08, INTGATE);
	idt_set_entry(idt, 154, (unsigned int) interrupt_handler_154, 0x08, INTGATE);
	idt_set_entry(idt, 155, (unsigned int) interrupt_handler_155, 0x08, INTGATE);
	idt_set_entry(idt, 156, (unsigned int) interrupt_handler_156, 0x08, INTGATE);
	idt_set_entry(idt, 157, (unsigned int) interrupt_handler_157, 0x08, INTGATE);
	idt_set_entry(idt, 158, (unsigned int) interrupt_handler_158, 0x08, INTGATE);
	idt_set_entry(idt, 159, (unsigned int) interrupt_handler_159, 0x08, INTGATE);
	idt_set_entry(idt, 160, (unsigned int) interrupt_handler_160, 0x08, INTGATE);
	idt_set_entry(idt, 161, (unsigned int) interrupt_handler_161, 0x08, INTGATE);
	idt_set_entry(idt, 162, (unsigned int) interrupt_handler_162, 0x08, INTGATE);
	idt_set_entry(idt, 163, (unsigned int) interrupt_handler_163, 0x08, INTGATE);
	idt_set_entry(idt, 164, (unsigned int) interrupt_handler_164, 0x08, INTGATE);
	idt_set_entry(idt, 165, (unsigned int) interrupt_handler_165, 0x08, INTGATE);
	idt_set_entry(idt, 166, (unsigned int) interrupt_handler_166, 0x08, INTGATE);
	idt_set_entry(idt, 167, (unsigned int) interrupt_handler_167, 0x08, INTGATE);
	idt_set_entry(idt, 168, (unsigned int) interrupt_handler_168, 0x08, INTGATE);
	idt_set_entry(idt, 169, (unsigned int) interrupt_handler_169, 0x08, INTGATE);
	idt_set_entry(idt, 170, (unsigned int) interrupt_handler_170, 0x08, INTGATE);
	idt_set_entry(idt, 171, (unsigned int) interrupt_handler_171, 0x08, INTGATE);
	idt_set_entry(idt, 172, (unsigned int) interrupt_handler_172, 0x08, INTGATE);
	idt_set_entry(idt, 173, (unsigned int) interrupt_handler_173, 0x08, INTGATE);
	idt_set_entry(idt, 174, (unsigned int) interrupt_handler_174, 0x08, INTGATE);
	idt_set_entry(idt, 175, (unsigned int) interrupt_handler_175, 0x08, INTGATE);
	idt_set_entry(idt, 176, (unsigned int) interrupt_handler_176, 0x08, INTGATE);
	idt_set_entry(idt, 177, (unsigned int) interrupt_handler_177, 0x08, INTGATE);
	idt_set_entry(idt, 178, (unsigned int) interrupt_handler_178, 0x08, INTGATE);
	idt_set_entry(idt, 179, (unsigned int) interrupt_handler_179, 0x08, INTGATE);
	idt_set_entry(idt, 180, (unsigned int) interrupt_handler_180, 0x08, INTGATE);
	idt_set_entry(idt, 181, (unsigned int) interrupt_handler_181, 0x08, INTGATE);
	idt_set_entry(idt, 182, (unsigned int) interrupt_handler_182, 0x08, INTGATE);
	idt_set_entry(idt, 183, (unsigned int) interrupt_handler_183, 0x08, INTGATE);
	idt_set_entry(idt, 184, (unsigned int) interrupt_handler_184, 0x08, INTGATE);
	idt_set_entry(idt, 185, (unsigned int) interrupt_handler_185, 0x08, INTGATE);
	idt_set_entry(idt, 186, (unsigned int) interrupt_handler_186, 0x08, INTGATE);
	idt_set_entry(idt, 187, (unsigned int) interrupt_handler_187, 0x08, INTGATE);
	idt_set_entry(idt, 188, (unsigned int) interrupt_handler_188, 0x08, INTGATE);
	idt_set_entry(idt, 189, (unsigned int) interrupt_handler_189, 0x08, INTGATE);
	idt_set_entry(idt, 190, (unsigned int) interrupt_handler_190, 0x08, INTGATE);
	idt_set_entry(idt, 191, (unsigned int) interrupt_handler_191, 0x08, INTGATE);
	idt_set_entry(idt, 192, (unsigned int) interrupt_handler_192, 0x08, INTGATE);
	idt_set_entry(idt, 193, (unsigned int) interrupt_handler_193, 0x08, INTGATE);
	idt_set_entry(idt, 194, (unsigned int) interrupt_handler_194, 0x08, INTGATE);
	idt_set_entry(idt, 195, (unsigned int) interrupt_handler_195, 0x08, INTGATE);
	idt_set_entry(idt, 196, (unsigned int) interrupt_handler_196, 0x08, INTGATE);
	idt_set_entry(idt, 197, (unsigned int) interrupt_handler_197, 0x08, INTGATE);
	idt_set_entry(idt, 198, (unsigned int) interrupt_handler_198, 0x08, INTGATE);
	idt_set_entry(idt, 199, (unsigned int) interrupt_handler_199, 0x08, INTGATE);
	idt_set_entry(idt, 200, (unsigned int) interrupt_handler_200, 0x08, INTGATE);
	idt_set_entry(idt, 201, (unsigned int) interrupt_handler_201, 0x08, INTGATE);
	idt_set_entry(idt, 202, (unsigned int) interrupt_handler_202, 0x08, INTGATE);
	idt_set_entry(idt, 203, (unsigned int) interrupt_handler_203, 0x08, INTGATE);
	idt_set_entry(idt, 204, (unsigned int) interrupt_handler_204, 0x08, INTGATE);
	idt_set_entry(idt, 205, (unsigned int) interrupt_handler_205, 0x08, INTGATE);
	idt_set_entry(idt, 206, (unsigned int) interrupt_handler_206, 0x08, INTGATE);
	idt_set_entry(idt, 207, (unsigned int) interrupt_handler_207, 0x08, INTGATE);
	idt_set_entry(idt, 208, (unsigned int) interrupt_handler_208, 0x08, INTGATE);
	idt_set_entry(idt, 209, (unsigned int) interrupt_handler_209, 0x08, INTGATE);
	idt_set_entry(idt, 210, (unsigned int) interrupt_handler_210, 0x08, INTGATE);
	idt_set_entry(idt, 211, (unsigned int) interrupt_handler_211, 0x08, INTGATE);
	idt_set_entry(idt, 212, (unsigned int) interrupt_handler_212, 0x08, INTGATE);
	idt_set_entry(idt, 213, (unsigned int) interrupt_handler_213, 0x08, INTGATE);
	idt_set_entry(idt, 214, (unsigned int) interrupt_handler_214, 0x08, INTGATE);
	idt_set_entry(idt, 215, (unsigned int) interrupt_handler_215, 0x08, INTGATE);
	idt_set_entry(idt, 216, (unsigned int) interrupt_handler_216, 0x08, INTGATE);
	idt_set_entry(idt, 217, (unsigned int) interrupt_handler_217, 0x08, INTGATE);
	idt_set_entry(idt, 218, (unsigned int) interrupt_handler_218, 0x08, INTGATE);
	idt_set_entry(idt, 219, (unsigned int) interrupt_handler_219, 0x08, INTGATE);
	idt_set_entry(idt, 220, (unsigned int) interrupt_handler_220, 0x08, INTGATE);
	idt_set_entry(idt, 221, (unsigned int) interrupt_handler_221, 0x08, INTGATE);
	idt_set_entry(idt, 222, (unsigned int) interrupt_handler_222, 0x08, INTGATE);
	idt_set_entry(idt, 223, (unsigned int) interrupt_handler_223, 0x08, INTGATE);
	idt_set_entry(idt, 224, (unsigned int) interrupt_handler_224, 0x08, INTGATE);
	idt_set_entry(idt, 225, (unsigned int) interrupt_handler_225, 0x08, INTGATE);
	idt_set_entry(idt, 226, (unsigned int) interrupt_handler_226, 0x08, INTGATE);
	idt_set_entry(idt, 227, (unsigned int) interrupt_handler_227, 0x08, INTGATE);
	idt_set_entry(idt, 228, (unsigned int) interrupt_handler_228, 0x08, INTGATE);
	idt_set_entry(idt, 229, (unsigned int) interrupt_handler_229, 0x08, INTGATE);
	idt_set_entry(idt, 230, (unsigned int) interrupt_handler_230, 0x08, INTGATE);
	idt_set_entry(idt, 231, (unsigned int) interrupt_handler_231, 0x08, INTGATE);
	idt_set_entry(idt, 232, (unsigned int) interrupt_handler_232, 0x08, INTGATE);
	idt_set_entry(idt, 233, (unsigned int) interrupt_handler_233, 0x08, INTGATE);
	idt_set_entry(idt, 234, (unsigned int) interrupt_handler_234, 0x08, INTGATE);
	idt_set_entry(idt, 235, (unsigned int) interrupt_handler_235, 0x08, INTGATE);
	idt_set_entry(idt, 236, (unsigned int) interrupt_handler_236, 0x08, INTGATE);
	idt_set_entry(idt, 237, (unsigned int) interrupt_handler_237, 0x08, INTGATE);
	idt_set_entry(idt, 238, (unsigned int) interrupt_handler_238, 0x08, INTGATE);
	idt_set_entry(idt, 239, (unsigned int) interrupt_handler_239, 0x08, INTGATE);
	idt_set_entry(idt, 240, (unsigned int) interrupt_handler_240, 0x08, INTGATE);
	idt_set_entry(idt, 241, (unsigned int) interrupt_handler_241, 0x08, INTGATE);
	idt_set_entry(idt, 242, (unsigned int) interrupt_handler_242, 0x08, INTGATE);
	idt_set_entry(idt, 243, (unsigned int) interrupt_handler_243, 0x08, INTGATE);
	idt_set_entry(idt, 244, (unsigned int) interrupt_handler_244, 0x08, INTGATE);
	idt_set_entry(idt, 245, (unsigned int) interrupt_handler_245, 0x08, INTGATE);
	idt_set_entry(idt, 246, (unsigned int) interrupt_handler_246, 0x08, INTGATE);
	idt_set_entry(idt, 247, (unsigned int) interrupt_handler_247, 0x08, INTGATE);
	idt_set_entry(idt, 248, (unsigned int) interrupt_handler_248, 0x08, INTGATE);
	idt_set_entry(idt, 249, (unsigned int) interrupt_handler_249, 0x08, INTGATE);
	idt_set_entry(idt, 250, (unsigned int) interrupt_handler_250, 0x08, INTGATE);
	idt_set_entry(idt, 251, (unsigned int) interrupt_handler_251, 0x08, INTGATE);
	idt_set_entry(idt, 252, (unsigned int) interrupt_handler_252, 0x08, INTGATE);
	idt_set_entry(idt, 253, (unsigned int) interrupt_handler_253, 0x08, INTGATE);
	idt_set_entry(idt, 254, (unsigned int) interrupt_handler_254, 0x08, INTGATE);
	idt_set_entry(idt, 255, (unsigned int) interrupt_handler_255, 0x08, INTGATE);


	// Load the IDT
	load_idt(idt_ptr);
}

void idt_set_entry(struct idt_entry* idt, int num, unsigned int base, unsigned short select, unsigned short type)
{
	idt[num].offset16_31 = (base >> 16) & 0xFFFF;
	idt[num].select = select;
	idt[num].type = type;
	idt[num].offset0_15 = base & 0xFFFF;
}

void page_fault_handler([[maybe_unused]] struct cpu_state cpu_state, [[maybe_unused]] struct stack_state stack_state){
	unsigned int err = stack_state.error_code;
	fb_write("Page fault:\n");

	fb_write("Present: ");
	fb_write(err & 1 ? "True": "False");
	fb_write("\n");
}

void interrupt_handler([[maybe_unused]] struct cpu_state cpu_state, unsigned int interrupt, [[maybe_unused]] struct stack_state stack_state)
{
	switch (interrupt) {
		case 0x21:
			keyboard_interrupt_handler();
			break;
		case 0x0e:
			page_fault_handler(cpu_state, stack_state);
			break;
		default:
			break;
	}

	pic_acknowledge(interrupt);
}

void setup_pic()
{
	// Remap the PIC
	pic_remap(PIC1_START_INTERRUPT, PIC2_START_INTERRUPT);

	// Only enable keyboard interrupts
	outb(PIC1_DATA, ~0x02);
	outb(PIC2_DATA, ~0x00);
	io_wait();
}

void pic_remap(int offset1, int offset2)
{
	unsigned char a1, a2;

	// Save masks
	a1 = inb(PIC1_DATA);
	a2 = inb(PIC2_DATA);

	// Start initialization sequence in cascade mode
	outb(PIC1_COMMAND, ICW1_INIT | ICW1_ICW4);
	outb(PIC2_COMMAND, ICW1_INIT | ICW1_ICW4);
	io_wait();  // Give PICs time to process the command

	// Set new vector offset
	outb(PIC1_DATA, offset1);
	outb(PIC2_DATA, offset2);
	io_wait();

	// Configure master PIC to recognize there is a slave PIC at IRQ2 (0000 0100)
	outb(PIC1_DATA, 4);
	outb(PIC2_DATA, 2);
	io_wait();

	// Set PICs to 8086/88 mode
	outb(PIC1_DATA, ICW4_8086);
	outb(PIC2_DATA, ICW4_8086);
	io_wait();

	// Restore saved masks
	outb(PIC1_DATA, a1);
	outb(PIC2_DATA, a2);
	io_wait();
}